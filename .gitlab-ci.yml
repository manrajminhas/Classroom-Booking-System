stages:
  - build
  - test
  - deploy

variables:
  NODE_IMAGE: node:22

build:
  image: ${NODE_IMAGE}
  stage: build
  script:
    - cd src/backend && npm ci && npm run build
    - cd ../mcp-server && npm ci && npm run build
    - cd ../frontend && npm ci && npm run build
  artifacts:
    paths:
      - src/backend/dist
      - src/mcp-server/dist
      - src/frontend/build
    expire_in: 1h

test:
  image: ${NODE_IMAGE}
  stage: test
  script:
    - cd src/backend && npm ci && npm run test --if-present
  dependencies:
    - build

deploy:
  stage: deploy
  image: docker:24
  services:
    - docker:dind
  script:
    - echo "Deploying using Docker Compose..."
    - docker compose build
    - docker compose up -d
  when: manual
  environment: production
  only:
    - main